<!DOCTYPE html><!--[if lte IE 7]> <html class="no-js ie67 ie678" lang="en"> <![endif]-->
<!--[if IE 8]> <html class="no-js ie8 ie678" lang="en"> <![endif]-->
<!--[if IE 9]> <html class="no-js ie9" lang="en"> <![endif]--><html lang="en"><head><meta charset="utf-8"><!--[if lt IE 9]>
<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]--><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width"><link rel="shortcut icon" href="/assets/images/favicon.png"><title>The Data System API</title><link  rel="stylesheet" href="/vendors/css/knacss.css" /><link  rel="stylesheet" href="/vendors/css/sunburst.css" /><link  rel="stylesheet" href="/assets/css/main.css" /><link  rel="stylesheet" href="/assets/css/home.css" /></head><body><div class="navbar fixed"><a href="/" class="nav-logo left"><img src="/assets/images/happycloud.png" alt="Happy Cloud"></a><span class="subtitle">The Data System API</span><a href="/hack/getting-started/" class="right">hack</a><a href="/host/install.html" class="right">host</a></div><div class="wrapper"><aside class="mod left w25 aside"><nav id="navigation" role="navigation"><ul class="first-level"><li class="big"><a href="/hack/getting-started/" class="label">Getting started</a></li><li class="big selected"><a href="/hack/cookbooks/" class="label">Cookbooks</a><ul class="second-level"><li class="small"><a href="/hack/cookbooks/data-system.html" class="label selected">The Data System API</a></li><li class="small"><a href="/hack/cookbooks/data-system-odm.html" class="label">The ODM for Data System API</a></li><li class="small"><a href="/hack/cookbooks/localization.html" class="label">Localize your applications</a></li></ul></li><li class="big"><a href="/hack/application-skeletons/" class="label">Application Skeletons</a></li><li class="big"><a href="/hack/contributing/" class="label">Contributing</a></li></ul></nav></aside><div id="main" role="main" class="mod pam w75"><h1 id="the-data-system-api">The Data System API</h1>
<p>The Data System API allows the access of the following:</p>
<ul>
<li>the data themselves</li>
<li>the CouchDB views (through &quot;requests&quot;)</li>
<li>the attachements (files)</li>
<li>the indexer</li>
<li>the accounts</li>
</ul>
<h2 id="generic-notes">Generic notes</h2>
<p>All the responses body are encoded in JSON and all the data you send along requests should be encoded in JSON.</p>
<p>You will find HTTP status code for response, here is what they mean:</p>
<ul>
<li>200: success</li>
<li>201: success (and something has been created)</li>
<li>204: success (and something has been deleted)</li>
<li>400: bad request</li>
<li>401: unauthorized</li>
<li>403: not authentificated</li>
<li>404: document not found</li>
<li>409: document already exists</li>
<li>500: internal server error</li>
</ul>
<p>All the requests that mention &quot;Requires authentification and authorization&quot; are likely to send 401 and 403 if the conditions are not met.
See <a href="#troubleshootings">troubleshootings</a> to understand what those error mean.</p>
<h3 id="todo-for-this-cookbook">Todo for this cookbook</h3>
<ul>
<li>Adding documentation about authentification and authorization process</li>
</ul>
<h2 id="data-api">Data API</h2>
<p>This API lets you manage data with four common operations: create, read, update and delete but utiliy functions like exist, find or merge can also help you.</p>
<h3 id="check-the-existence-of-a-document">Check the existence of a document</h3>
<pre class="highlighted"><code class="undefined">GET /data/exist/:id/
Param:
  id: the document ID
Response:
  Status code: 200|500
  Body
    200: {exist: true|false}
    500: {error: "the error message"}</code></pre>
<p>Requires authentification and authorization.</p>
<h3 id="retrieving-a-document-for-a-specific-id">Retrieving a document for a specific ID</h3>
<pre class="highlighted"><code class="undefined">GET /data/:id/
Param:
  id: the document ID
Response:
  Status code: 200|404|500
  Body
    200: {the document}
    404: {error: "not found"}
    500: {error: "the error message"}</code></pre>
<p>Requires authentification and authorization.</p>
<h3 id="creating-a-document-automatically-generates-a-new-id-">Creating a document (automatically generates a new ID)</h3>
<pre class="highlighted"><code class="undefined">POST /data/
Param:
  Body {the document to add}
Response:
  Status code: 201|500
  Body
    201: {"_id": the document ID}
    500: {error: "the error message"}</code></pre>
<p>Requires authentification and authorization.</p>
<h3 id="creating-a-document-with-specified-id-">Creating a document (with specified ID)</h3>
<pre class="highlighted"><code class="undefined">POST /data/:id/
Param:
  id: the document ID
  Body {the document to add}
Response:
  Status code: 201|409|500
  Body
    201: {"_id": the document ID}
    409: {error: "The document exists"}
    500: {error: "the error message"}</code></pre>
<p>Requires authentification and authorization.</p>
<h3 id="update-a-document-old-version-is-fully-overwritten-">Update a document (old version is fully overwritten)</h3>
<pre class="highlighted"><code class="undefined">PUT /data/:id/
Param:
  id: the document ID
  Body {the document to update}
Response
  Status code: 200|404|500
  Body
    200: {success: true}
    404: {error: "not found"}
    500: {error: "the error message"}</code></pre>
<p>Requires authentification and authorization.</p>
<h3 id="update-or-create-a-document-with-specified-id-">Update or create a document (with specified ID)</h3>
<pre class="highlighted"><code class="undefined">PUT  /data/upsert/:id/
Param:
  id: the document ID
  Body {the document to add or update}
Response
  Status code: 200|201|500
  Body
    200: {success: true}
    201: {"_id": the document ID}
    500: {error: "the error message"}</code></pre>
<p>Requires authentification and authorization.</p>
<h3 id="deleting-a-document">Deleting a document</h3>
<pre class="highlighted"><code class="undefined">DELETE /data/:id/
Param:
  id: the document ID
Response
  Status code: 204|404|500
  Body
    204: {success: true}
    404: {error: "not found"}
    500: {error: "the message"}</code></pre>
<p>Requires authentification and authorization.</p>
<h3 id="updating-a-document-only-the-given-fields-">Updating a document (only the given fields)</h3>
<pre class="highlighted"><code class="undefined">PUT /data/merge/:id
Param:
  Body {the fields of the document to update}
Response
  Status code: 200|500
  Body
    200: {success: true}
    500: {error: "the message"}</code></pre>
<p>Requires authentification and authorization.</p>
<h2 id="request-api">Request API</h2>
<p>The Request API is used to create, update, delete and retrieve documents based on CouchDB views.</p>
<h3 id="getting-documents-from-a-view">Getting documents from a view</h3>
<pre class="highlighted"><code class="undefined">POST /request/:type/:req_name/
Param:
  type: the doctype name
  req_name: the name of the request
  Body {
    key: only returns document for this key
    keys: [only returns document for this array of keys]
    limit: number of documents to return
    skip: number of documents to skip
    startKey: only returns document after this key
    endKey: only returns document before this key
  }
  The body is fully optional.
Response
  Status code: 200|404|500
  Body
    200: [an array of documents]
    404: {error: "not found"}
    500: {error: "the error message"}</code></pre>
<p>Requires authentification and authorization.</p>
<h3 id="create-or-update-a-view">Create or update a view</h3>
<pre class="highlighted"><code class="undefined">PUT /request/:type/:req_name/
Param:
  type: the doctype name
  req_name: the name of the request
  Body {
    map: the map function
    recuce: the reduce function (optional)
  }
Response
  Status code: 200|500
  Body
    200: {success: true}
    500: {error: "the error message"}</code></pre>
<p>Requires authentification and authorization.</p>
<h3 id="delete-all-the-docs-returned-by-the-specified-view">Delete all the docs returned by the specified view</h3>
<pre class="highlighted"><code class="undefined">PUT /request/:type/:req_name/destroy/
Param:
  type: the doctype name
  req_name: the name of the request
  Body {
    key: only returns document for this key
    keys: [only returns document for this array of keys]
    limit: number of documents to return
    skip: number of documents to skip
    startKey: only returns document after this key
    endKey: only returns document before this key
  }
  The body is fully optional.
Response
  Status code: 204|404|500
  Body
    204: {success: true}
    404: {error: "not found"}
    500: {error: "the error message"}</code></pre>
<p>Requires authentification and authorization.</p>
<h3 id="delete-the-view">Delete the view</h3>
<pre class="highlighted"><code class="undefined">DELETE /request/:type/:req_name/
Param:
  type: the doctype name
  req_name: the name of the request
Response
  Status code: 204|404|500
  Body
    204: {success: true}
    404: {error: "not found"}
    500: {error: "the error message"}</code></pre>
<p>Requires authentification and authorization.</p>
<h2 id="attachments-api">Attachments API</h2>
<p>Attachements are basically files attached to documents. It allows you to upload and download files (e.g. music library application)</p>
<h3 id="save-a-file-as-attachement-of-a-document">Save a file as attachement of a document</h3>
<pre class="highlighted"><code class="undefined">POST /data/:id/attachments/
Param:
  id: ID of the document the file will be attached to
  Body {
    a file send through multipart form
    name: force the file name
  }
Response
  Status code: 201|400|404|500
  Body
    201: {success: true}
    400: {error: "No file sent"}
    404: {error: "not found"}
    500: {error: "the error message"}</code></pre>
<p>Requires authentification and authorization.</p>
<h3 id="download-an-attached-file">Download an attached file</h3>
<pre class="highlighted"><code class="undefined">GET /data/:id/attachments/:name
Param:
  id: ID of the document the file is attached to
  name: the file name
Response
  Status code: 404|500
  Body
    200: {success: true}
    404: {error: "not found"}
    500: {error: "the error message"}</code></pre>
<p>Requires authentification and authorization.</p>
<h3 id="delete-an-attached-file">Delete an attached file</h3>
<pre class="highlighted"><code class="undefined">DELETE /data/:id/attachments/:name
Param:
  id: ID of the document the file is attached to
  name: the file name
Response
  Status code: 204|404|500
  Body
    204: {success: true}
    404: {error: "not found"}
    500: {error: "the error message"}</code></pre>
<p>Requires authentification and authorization.</p>
<h2 id="indexer-api">Indexer API</h2>
<p>We use <a href="https://pypi.python.org/pypi/Whoosh/">Whoosh</a> as an indexer but you can only access it through its API in the Data System.</p>
<h3 id="indexing">Indexing</h3>
<pre class="highlighted"><code class="undefined">POST /data/index/:id
Param:
  id: ID of the document to index
  Body {
    fields: [an array of text fields name that will be indexed]
  }
Response
  Status code: 200|404|500
  Body
    200: {success: true}
    404: {error: "not found"}
    500: {error: "the error message"}</code></pre>
<h3 id="searching-10-documents-that-match-the-best-the-query">Searching 10 documents that match the best the query</h3>
<pre class="highlighted"><code class="undefined">POST /data/search/:type
Param:
  type: the doctype the searched documents belongs
  Body {
    query: "search query"
  }
Response
  Status code: 200|500
  Body
    200: {rows: [the documents]}
    500: {error: "the error message"}</code></pre>
<h3 id="removing-indexation-for-a-given-document">Removing indexation for a given document</h3>
<pre class="highlighted"><code class="undefined">DELETE /data/index/:id
Param:
  id: the ID of the document that will be unindex
Response
  Status code: 200|404|500
  Body
    200: {success: true}
    404: {error: "not found"}
    500: {error: "the error message"}</code></pre>
<h3 id="clearing-the-indexer">Clearing the indexer</h3>
<pre class="highlighted"><code class="undefined">DELETE /data/index/clear-all/
Response
  Status code: 200|500
  Body
    200: {success: true}
    500: {error: "the error message"}</code></pre>
<h2 id="miscellaneous">Miscellaneous</h2>
<h3 id="getting-the-doctype-list">Getting the doctype list</h3>
<pre class="highlighted"><code class="undefined">GET /doctypes
Response
  Status code: 200|500
  Body
    200: ['list', 'of', 'doctype', 'names']</code></pre>
<h1 id="example-of-use">Example of use</h1>
<p>How to request the Data System from a NodeJS application ? You can use any HTTP client but we recommend (, use and maintain) request-json:</p>
<pre class="highlighted"><code class="bash">npm install request-json --save</code></pre>
<pre class="highlighted"><code class="javascript">Client = require(<span class="string">'request-json'</span>).JsonClient;

<span class="comment">// The data system listens to localhost:9101</span>
dataSystem = <span class="keyword">new</span> Client(<span class="string">'http://localhost:9101'</span>);

<span class="comment">// In production we must authentificate the application</span>
<span class="keyword">if</span>(process.env.NODE_ENV === <span class="string">'production'</span>) {
  user = process.env.NAME;
  password = process.env.TOKEN;
  dataSystem.setBasicAuth(user, password);
}

<span class="comment">// The request must be created first, let's say it is</span>
dataSystem.post(<span class="string">'/request/alarm/all/'</span>, <span class="keyword">function</span>(err, res, body) {
  <span class="keyword">if</span>(err !== <span class="literal">null</span> || (res !== <span class="literal">null</span> &amp;&amp; res.statusCode != <span class="number">200</span>)) {
    <span class="keyword">if</span>(res !== <span class="literal">null</span>) {code = res.statusCode;} <span class="keyword">else</span> { code = <span class="string">"no status code"</span>; }
    console.log(<span class="string">"An error occurred -- ["</span> + code + <span class="string">"] "</span> + err);
  }
  <span class="keyword">else</span> {
    console.log(<span class="string">"List of all the alarms"</span>);
    console.log(body);
  }
}
});</code></pre>
<p>For more examples and the complete documentation of request-json, please see the <a href="http://github.com/mycozycloud/request-json/">github repository</a> of the module.</p>
<p><a name="troubleshootings"></a></p>
<h1 id="troubleshootings">Troubleshootings</h1>
<p>Coming soon...</p>
<h2 id="authentification-and-authorization">Authentification and authorization</h2>
<p>Coming soon...</p>
</div><footer id="footer" role="contentinfo" class="line pam row"><a href="https://github.com/mycozycloud">Github</a><a href="irc://irc.freenode.net/cozycloud">IRC</a><a href="mailto:contact@cozycloud.cc">Contact</a><a href="https://groups.google.com/forum/?fromgroups#!forum/cozy-cloud">mailing-list</a><a href="https://cozycloud.cc">Cozy Cloud</a></footer></div><script defer="defer"  src="/vendors/javascripts/jquery-2.0.3.min.js"></script><script defer="defer"  src="/assets/javascripts/main.js"></script></body></html>