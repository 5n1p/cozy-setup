<!DOCTYPE html><!--[if lte IE 7]> <html class="no-js ie67 ie678" lang="en"> <![endif]-->
<!--[if IE 8]> <html class="no-js ie8 ie678" lang="en"> <![endif]-->
<!--[if IE 9]> <html class="no-js ie9" lang="en"> <![endif]-->
<html lang="en">
  <head>
    <meta charset="utf-8"><!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>Discover Americano
    </title><link  rel="stylesheet" href="/vendors/css/knacss.css" /><link  rel="stylesheet" href="/vendors/css/sunburst.css" /><link  rel="stylesheet" href="/assets/css/main.css" /><link  rel="stylesheet" href="/assets/css/home.css" />
  </head>
  <body>
    <div class="navbar fixed"><a href="/" class="nav-logo left"><img src="/assets/images/happycloud.png" alt="Happy Cloud"></a><span class="subtitle">Discover Americano</span><a href="/hack/getting-started/" class="right">hack</a><a href="/host/install.html" class="right">host</a></div>
    <div class="wrapper">
      <aside class="mod left w25 aside">
        <nav id="navigation" role="navigation">
          <ul class="first-level">
            <li class="big selected"><a href="/hack/getting-started/" class="label">Getting started</a>
              <ul class="second-level">
                <li class="small"><a href="/hack/getting-started/setup-environment.html" class="label">Setup the environment</a>
                </li>
                <li class="small"><a href="/hack/getting-started/first-app.html" class="label">Your first app in 30 minutes</a>
                </li>
                <li class="small"><a href="/hack/getting-started/architecture-overview.html" class="label">Architecture Overview</a>
                </li>
                <li class="small"><a href="/hack/getting-started/play-with-data-system.html" class="label">Play with the Data System</a>
                </li>
                <li class="small"><a href="/hack/getting-started/discover-americano.html" class="label selected">Discover Americano</a>
                </li>
                <li class="small"><a href="/hack/getting-started/learn-single-page-app-way.html" class="label">Learn the Single Page App Way</a>
                </li>
              </ul>
            </li>
            <li class="big"><a href="/hack/cookbooks/" class="label">Cookbooks</a>
            </li>
            <li class="big"><a href="/hack/application-skeletons/" class="label">Application Skeletons</a>
            </li>
          </ul>
        </nav>
      </aside>
      <div id="main" role="main" class="mod pam w75"><h1>Discover Americano</h1>
<p>The more your application grows the harder it is to maintain. <a href="http://expressjs.com/">Express.js</a> is incredibely powerful but lacks at helping developer structuring their code.  To ease development without sacrifying maintainability, let&#39;s try <a href="https://github.com/frankrousseau/americano">Americano</a> the framework that makes Express.js more opinionated about configuration and code organization without making it a magician hat (&quot;magic&quot; in code is never a good idea).</p>
<p>Americano extends Express: everything that works with Express will work out of the box with Americano. It&#39;s really just a matter of convention!</p>
<p>Also, Americano is modular so you can extend it with plugins. That&#39;s what we did with the JugglingDB ODM that comes with the americano-cozy plugin that we are going to use here.</p>
<h3>What you will achieve</h3>
<ul>
<li>Learning a new framework without losing the work you&#39;ve made so far by making the bookmark app you&#39;ve built an Americano app with no effort.</li>
<li>Learning how to painlessly structure your code and improve your capacity to maintain your code.</li>
</ul>
<h3>Source code</h3>
<p>The source code of this tutorial can be found <a href="https://github.com/mycozycloud/cozy-tutorial/tree/americano">here</a>.</p>
<h3>Getting stated</h3>
<p>In a brand new application folder, install americano:</p>
<pre class="highlighted"><code class="bash">mkdir bookmark-americano &amp;&amp; cd bookmark-americano/
npm install americano --save
npm install americano-cozy --save <span class="comment"># the plugin that will handle database stuff</span></code></pre>
<p>Then put the following in the server.js file:</p>
<pre class="highlighted"><code class="javascript"><span class="comment">// ./server.js</span>
<span class="keyword">var</span> americano = require(<span class="string">'americano'</span>);

<span class="keyword">var</span> port = process.env.PORT || <span class="number">9250</span>;
americano.start({name: <span class="string">'yourapp'</span>, port: port});</code></pre>
<p>We&#39;re done! We said no effort but still!</p>
<h2>File structure</h2>
<p>Americano constrains the way your file structure should be, let&#39;s see how:</p>
<ul>
<li>client/ - all your client files (templates...)</li>
<li>public/ - all your public assets (images, css, javascript)</li>
<li>server/<ul>
<li>controllers/ - we&#39;ll come back on what controllers are<ul>
<li>routes.js - we&#39;ll come back on what the router is</li>
</ul>
</li>
<li>models/ - we&#39;ll see how to define a model<ul>
<li>requests.js - where you put the requests to access your data</li>
</ul>
</li>
<li>config.js - Americano configuration</li>
</ul>
</li>
<li>package.json : holds your app information and dependencies</li>
<li>server.js : the application starter</li>
</ul>
<p>Note that Americano makes mandatory the &quot;server&quot; structure but let you do whatever you want with the client/public folders.</p>
<p>You might recognize familiar concepts: Model, Controller and somehow the View. It is important you understand that even if Americano doesn&#39;t actually put shiny MVC into Express, it brings spearation of concerns to application which is what really matters.</p>
<p>Start by creating the architecture then we&#39;ll move on the models creation.</p>
<h2>Define the models</h2>
<p>The models folder allow you put the doctype definition in separate files. Let&#39;s take the code we previously had in server.js and move it to <code>server/models/bookmark.js</code>:</p>
<pre class="highlighted"><code class="javascript">americano = require(<span class="string">'americano'</span>);

<span class="comment">// The americano plugin wraps the "db.define" JugglingDB function in a simpler "getModel" call</span>
module.exports = Bookmark = americano.getModel(<span class="string">'bookmarks'</span>, {
  <span class="string">"id"</span>: String,
  <span class="string">"title"</span>: String,
  <span class="string">"url"</span>: { <span class="string">"type"</span>: String, <span class="string">"default"</span>: <span class="string">""</span>}
});

<span class="comment">// You can easily define here some helpers or method for bookmarks</span></code></pre>
<p>Then move to server/models/requests.js so we can define the request we are going to use. The nice part of the cozy plugin for americano is that it makes requests declaration very clear:</p>
<pre class="highlighted"><code class="javascript">module.exports =
  bookmark: {
    all: <span class="keyword">function</span>(doc) {
      emit(doc._id, doc);
    }
  };</code></pre>
<p>This will <strong>automatically</strong> do the old &quot;Bookmark.defineRequest&quot; when the server starts. Americano&#39;s Cozy plugin knows that the &quot;all request&quot; is often the same and offers this handy shortcut:</p>
<pre class="highlighted"><code class="javascript">americano = require(<span class="string">'americano'</span>);

module.exports =
  bookmark: {
    all: americano.defaultRequests.all
  };</code></pre>
<p>You can now add a helper to your bookmark model (we&#39;ll use it in the next section):</p>
<pre class="highlighted"><code class="javascript"><span class="comment">// server/models/bookmark.js</span>

Bookmark.all = <span class="keyword">function</span>(callback) {
  Bookmark.request(<span class="string">"all"</span>, {}, <span class="keyword">function</span>(err, bookmarks) {
    callback(<span class="literal">null</span>, bookmarks);
  });
};</code></pre>
<p>Now let&#39;s focus on the business logic of your application.</p>
<h2>Organize your code with Controllers</h2>
<p>Create the bookmark controller: server/controllers/bookmarks.js</p>
<pre class="highlighted"><code class="javascript">Bookmark = require(<span class="string">'../models/bookmark'</span>);

module.exports.list = <span class="keyword">function</span>(req, res) {
  Bookmark.all(<span class="keyword">function</span>(err, bookmarks) {
    <span class="keyword">if</span>(err != <span class="literal">null</span>) {
      res.send(<span class="number">500</span>, <span class="string">"An error has occurred -- "</span> + err);
    }
    <span class="keyword">else</span> {
      data = {<span class="string">"bookmarks"</span>: bookmarks}
      res.render(<span class="string">'index.jade'</span>, data, <span class="keyword">function</span>(err, html) {
        res.send(<span class="number">200</span>, html);
      });
    }
  });
};

<span class="comment">// We define a new route that will handle bookmark creation</span>
module.exports.add = <span class="keyword">function</span>(req, res) {
  Bookmark.create(req.body, <span class="keyword">function</span>(err, bookmark) {
    <span class="keyword">if</span>(err != <span class="literal">null</span>) {
      res.send(<span class="number">500</span>, <span class="string">"An error has occurred -- "</span> + err);
    }
    <span class="keyword">else</span> {
      res.redirect(<span class="string">'back'</span>);
    }
  });
};

<span class="comment">// We define another route that will handle bookmark deletion</span>
module.exports.<span class="keyword">delete</span> = <span class="keyword">function</span>(req, res) {
  Bookmark.find(req.params.id, <span class="keyword">function</span>(err, bookmark) {
    <span class="keyword">if</span>(err != <span class="literal">null</span>) {
      res.send(<span class="number">500</span>, <span class="string">"Bookmark couldn't be retrieved -- "</span> + err);
    }
    <span class="keyword">else</span> <span class="keyword">if</span>(bookmark == <span class="literal">null</span>) {
      res.send(<span class="number">404</span>, <span class="string">"Bookmark not found"</span>);
    }
    <span class="keyword">else</span> {
      bookmark.destroy(<span class="keyword">function</span>(err) {
        <span class="keyword">if</span>(err != <span class="literal">null</span>) {
          res.send(<span class="number">500</span>, <span class="string">"An error has occurred -- "</span> + err);
        }
        <span class="keyword">else</span> {
          res.redirect(<span class="string">'back'</span>);
        }
      });
    }
  });
};</code></pre>
<p>We basically copied and pasted what was in the old server.js and removed the
&quot;which URL will trigger that action&quot; part to focus on the code itself.</p>
<p>You probably noticed the &quot;require&quot; instruction. It loads the bookmark model we
defined earlier. More precisely, it loads what has been module.exports&#39;ed (this
is NodeJS stuff, abuse that to create small modules of code).</p>
<p>Don&#39;t hesitate to split your code in multiple coherent controllers (one for
bookmarks, one for tags, ...)!</p>
<h2>Routing</h2>
<p>There is still one very important missing thing, the routes. The routes are the
&quot;which URL will trigger which action&quot; information.</p>
<p>We put them in a dedicated file so you don&#39;t have to look at every single
controllers when you are looking for a specific piece of code. Just check the
routes, they are the map of your application.</p>
<p>Americano <strong>automatically</strong> handles their loading when the server starts and
makes their syntax handy:</p>
<pre class="highlighted"><code class="javascript"><span class="comment">// ./server/controllers/routes.js</span>

<span class="keyword">var</span> bookmarks = require(<span class="string">'./bookmarks'</span>);

module.exports = {
  <span class="string">''</span>: {
    get: bookmarks.list
  },
  <span class="string">'add'</span>: {
    post: bookmarks.add
  },
  <span class="string">'delete/:id'</span>: {
    get: bookmarks.<span class="keyword">delete</span>
  }
};</code></pre>
<p>Please note that every &quot;route&quot; is <strong>automatically</strong> prefixed by a &#39;/&#39; so you don&#39;t need to put it yourself.</p>
<p>You can also bind different HTTP verbs to the same route:</p>
<pre class="highlighted"><code class="javascript"><span class="comment">// this example will not work with the code you have, you must change the template for that</span>
module.exports = {
  <span class="string">'bookmarks'</span>: {
    get: bookmarks.list
    post: bookmarks.add
  },
};</code></pre>
<h2>Configuration</h2>
<p>Now our application should already be working but there is one thing we left aside: configuration.</p>
<p>Again, Americano will provides you a handy syntax and loads everything <strong>automatically</strong> at start:</p>
<pre class="highlighted"><code class="javascript"><span class="comment">// ./server/config.js</span>

<span class="keyword">var</span> americano = require(<span class="string">'americano'</span>);

module.exports = {
  common: [
    americano.bodyParser(),
    americano.methodOverride(),
    americano.errorHandler({
      dumpExceptions: <span class="literal">true</span>,
      showStack: <span class="literal">true</span>
    }),
    americano.static(__dirname + <span class="string">'/../public'</span>, {
      maxAge: <span class="number">86400000</span>
    }),
    americano.set(<span class="string">'views'</span>, __dirname + <span class="string">'/../client'</span>),
    americano.engine(<span class="string">'.html'</span>, require(<span class="string">'jade'</span>).__express)
  ],
  development: [
    americano.logger(<span class="string">'dev'</span>)
  ],
  production: [
    americano.logger(<span class="string">'short'</span>)
  ]
};</code></pre>
<p>The configuration works exactly like in Express (remember, Americano extends
Express!) so be sure to change it the way you like.</p>
<h2>What&#39;s next ?</h2>
<p>We splitted our application into logical pieces and it can now grow without us
worrying about coming back later to make modification abd being completely
lost.</p>
<p>You discovered Americano, our favorite framework but you can use the one you
like, stick with ExpressJS or check out <a href="http://flatironjs.org/">Flatiron</a>,
<a href="http://sailsjs.org/">Sails.js</a> or <a href="http://compoundjs.com/">Compound.js</a>.  As
we repeat again and again, a Cozy app is nothing more than a web app.</p>
<p>We are almost done with Cozy&#39;s basics, there is still one concept 
we&#39;d like to introduce you. Are you ready to <a href="/hack/getting-started/learn-single-page-app-way.html">learn the single page app 
way</a>?</p>

      </div>
      <footer id="footer" role="contentinfo" class="line pam row"><a href="https://github.com/mycozycloud">github</a><a href="irc://irc.freenode.net/cozycloud">IRC</a><a href="mailto:contact@cozycloud.cc">contact</a><a href="https://groups.google.com/forum/?fromgroups#!forum/cozy-cloud">mailing-list</a><a href="https://cozycloud.cc">cozy cloud</a></footer>
    </div><script defer="defer"  src="/vendors/javascripts/jquery-2.0.3.min.js"></script><script defer="defer"  src="/assets/javascripts/main.js"></script>
  </body>
</html>